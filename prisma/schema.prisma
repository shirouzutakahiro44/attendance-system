// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  MANAGER
  ADMIN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
}

enum Department {
  FACTORY_1
  FACTORY_2
  FACTORY_3
  PRESS
  WELDING
  INDIRECT
}

model User {
  id             String         @id @default(uuid())
  employeeId     String         @unique @map("employee_id")
  email          String?        @unique
  passwordHash   String         @map("password_hash")
  firstName      String         @map("first_name")
  lastName       String         @map("last_name")
  firstNameKana  String?        @map("first_name_kana")
  lastNameKana   String?        @map("last_name_kana")
  department     Department
  role           Role           @default(EMPLOYEE)
  employmentType EmploymentType @default(FULL_TIME) @map("employment_type")
  hireDate       DateTime       @map("hire_date")
  hourlyRate     Decimal?       @map("hourly_rate") @db.Decimal(10, 2)
  monthlySalary  Decimal?       @map("monthly_salary") @db.Decimal(10, 2)
  nfcCardId      String?        @unique @map("nfc_card_id")
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  deletedAt      DateTime?      @map("deleted_at")

  managedDepartments DepartmentManager[]
  sessions           Session[]
  timeRecords        TimeRecord[]
  attendanceDaily    AttendanceDaily[]
  auditLogs          AuditLog[]
  profile            UserProfile?
  pointHistory       PointHistory[]
  achievements       UserAchievement[]
  quests             UserQuest[]
  shifts             Shift[]

  @@map("users")
}

model DepartmentManager {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  department   Department
  assignedAt   DateTime   @default(now()) @map("assigned_at")
  unassignedAt DateTime?  @map("unassigned_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, department])
  @@map("department_managers")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  lastActivity DateTime @default(now()) @map("last_activity")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

enum RecordType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
  TEMP_OUT
  TEMP_RETURN
}

enum DeviceType {
  WEB
  MOBILE
  NFC
  MANUAL
}

model TimeRecord {
  id             String     @id @default(uuid())
  userId         String     @map("user_id")
  recordType     RecordType @map("record_type")
  recordedAt     DateTime   @map("recorded_at")
  location       String?
  deviceType     DeviceType @map("device_type")
  ipAddress      String?    @map("ip_address")
  isModified     Boolean    @default(false) @map("is_modified")
  originalTime   DateTime?  @map("original_time")
  modifiedBy     String?    @map("modified_by")
  modifiedReason String?    @map("modified_reason")
  createdAt      DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, recordedAt])
  @@map("time_records")
}

enum AttendanceStatus {
  NORMAL
  LATE
  EARLY_LEAVE
  ABSENT
  HOLIDAY
  PAID_LEAVE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model AttendanceDaily {
  id                  String           @id @default(uuid())
  userId              String           @map("user_id")
  workDate            DateTime         @map("work_date") @db.Date
  clockIn             DateTime?        @map("clock_in")
  clockOut            DateTime?        @map("clock_out")
  breakDuration       Int              @default(0) @map("break_duration") // minutes
  actualWorkMinutes   Int              @default(0) @map("actual_work_minutes")
  overtimeMinutes     Int              @default(0) @map("overtime_minutes")
  lateNightMinutes    Int              @default(0) @map("late_night_minutes")
  holidayWorkMinutes  Int              @default(0) @map("holiday_work_minutes")
  status              AttendanceStatus @default(NORMAL)
  approvalStatus      ApprovalStatus   @default(PENDING) @map("approval_status")
  approvedBy          String?          @map("approved_by")
  approvedAt          DateTime?        @map("approved_at")
  notes               String?
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, workDate])
  @@index([workDate])
  @@index([userId])
  @@map("attendance_daily")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  action      AuditAction
  targetTable String?     @map("target_table")
  targetId    String?     @map("target_id")
  oldValue    Json?       @map("old_value")
  newValue    Json?       @map("new_value")
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([targetTable, targetId])
  @@map("audit_logs")
}

// ========== Gamification Models ==========

enum AvatarType {
  EGG        // 卵
  CHICK      // ひよこ
  CHICKEN    // 鶏
  ROOSTER    // 雄鶏
  PHOENIX    // 不死鳥
}

model UserProfile {
  id                String      @id @default(uuid())
  userId            String      @unique @map("user_id")
  avatarUrl         String?     @map("avatar_url")
  avatarType        AvatarType  @default(EGG) @map("avatar_type")
  level             Int         @default(1)
  totalPoints       Int         @default(0) @map("total_points")
  currentPoints     Int         @default(0) @map("current_points")
  stars             Int         @default(0)
  currentTitle      String?     @map("current_title")
  bio               String?
  preferences       Json?       // User preferences and settings
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("user_profiles")
}

enum PointType {
  EARLY_CLOCK_IN_10_6  // 10-6分前打刻
  EARLY_CLOCK_IN_5_0   // 5-0分前打刻
  LATE_CLOCK_IN        // 遅刻
  QUEST_COMPLETE       // クエスト完了
  STREAK_BONUS         // 連続ボーナス
  ACCURACY_BONUS       // 正確率ボーナス
  SPECIAL_REWARD       // 特別報酬
}

model PointHistory {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  points      Int
  pointType   PointType @map("point_type")
  description String?
  referenceId String?   @map("reference_id") // Reference to timeRecord or quest
  date        DateTime  @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, date])
  @@map("point_histories")
}

model Achievement {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String
  iconUrl     String?  @map("icon_url")
  category    String   // 出勤、連続、特別など
  points      Int      @default(0)
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  isEquipped    Boolean  @default(false) @map("is_equipped")

  user        User        @relation(fields: [userId], references: [id])
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

enum QuestType {
  DAILY
  WEEKLY
  MONTHLY
  PERSONAL
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CLAIMED
}

model Quest {
  id           String      @id @default(uuid())
  code         String      @unique
  name         String
  description  String
  questType    QuestType   @map("quest_type")
  targetValue  Int         @map("target_value")
  rewardPoints Int         @map("reward_points")
  startDate    DateTime    @map("start_date")
  endDate      DateTime    @map("end_date")
  conditions   Json        // Flexible conditions for quest completion
  createdAt    DateTime    @default(now()) @map("created_at")

  userQuests UserQuest[]

  @@map("quests")
}

model UserQuest {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  questId      String      @map("quest_id")
  status       QuestStatus @default(ACTIVE)
  progress     Int         @default(0)
  completedAt  DateTime?   @map("completed_at")
  claimedAt    DateTime?   @map("claimed_at")
  createdAt    DateTime    @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id])
  quest Quest @relation(fields: [questId], references: [id])

  @@unique([userId, questId])
  @@index([userId, status])
  @@map("user_quests")
}

// ========== Shift Management ==========

model Shift {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  date       DateTime @db.Date
  startTime  DateTime @map("start_time")
  endTime    DateTime @map("end_time")
  breakMinutes Int    @default(60) @map("break_minutes")
  location   String?
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([date])
  @@map("shifts")
}